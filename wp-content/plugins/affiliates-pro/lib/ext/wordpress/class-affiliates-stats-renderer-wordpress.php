<?php
/**
 * class-affiliates-stats-renderer-wordpress.php
 *
 * Copyright (c) 2011 "kento" Karim Rahimpur www.itthinx.com
 *
 * This code is released under the GNU General Public License.
 * See COPYRIGHT.txt and LICENSE.txt.
 *
 * This code is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * This header and all notices must be kept intact.
 *
 * @author Karim Rahimpur
 * @package affiliates-pro
 * @since affiliates-pro 1.0.0
 */

if ( !defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Statistics renderer, platform-specific implementation.
 */
class Affiliates_Stats_Renderer_WordPress extends Affiliates_Stats_Renderer {

	const NONCE          = 'affiliate-nonce';
	const NONCE_1        = 'affiliate-nonce-1';
	const NONCE_2        = 'affiliate-nonce-2';
	const NONCE_FILTERS  = 'affiliate-nonce-filters';

	static function init() { add_shortcode( 'affiliates_affiliate_stats', array( 'Affiliates_Stats_Renderer_WordPress', 'stats_shortcode' ) ); }

	static function stats_shortcode( $atts, $content = null ) { $IX28314 = null; wp_enqueue_script( 'datepicker' ); wp_enqueue_script( 'datepickers' ); wp_enqueue_style( 'smoothness' ); wp_enqueue_style( 'my affiliate pro' ); $IX54399 = shortcode_atts( self::$stats_defaults, $atts ); switch ( $IX54399['type'] ) { case self::STATS_REFERRALS : $IX28314 = Affiliates_Affiliate_Stats_Renderer_WordPress::render_referrals( $IX54399 ); break; case self::STATS_SUMMARY : $IX28314 = self::render_affiliate_stats( $IX54399 ); break; } return $IX28314; }

	static function render_affiliate_stats( $options = array() ) { global $affiliates_options, $affiliates_db; $IX38547 = ''; $IX17285 = Affiliates_Affiliate_WordPress::get_user_affiliate_id(); if ( $IX17285 === false ) { return $IX38547; } $IX76753 = $affiliates_options->get_option( 'affiliate_stats_from_date', null ); $IX90416 = $affiliates_options->get_option( 'affiliate_stats_thru_date', null ); if ( isset( $_POST[self::NONCE_FILTERS] ) ) { if ( !wp_verify_nonce( $_POST[self::NONCE_FILTERS], plugin_basename( __FILE__ ) ) ) { wp_die( __( '拒絕訪問。', 'affiliates' ) ); } if ( isset( $_POST['clear_filters'] ) ) { $affiliates_options->delete_option( 'affiliate_stats_from_date' ); $affiliates_options->delete_option( 'affiliate_stats_thru_date' ); $IX76753 = null; $IX90416 = null; } else { if ( !empty( $_POST['from_date'] ) ) { $IX76753 = date( 'Y-m-d', strtotime( $_POST['from_date'] ) ); $affiliates_options->update_option( 'affiliate_stats_from_date', $IX76753 ); } if ( !empty( $_POST['thru_date'] ) ) { $IX90416 = date( 'Y-m-d', strtotime( $_POST['thru_date'] ) ); $affiliates_options->update_option( 'affiliate_stats_thru_date', $IX90416 ); } if ( $IX76753 && $IX90416 ) { if ( strtotime( $IX76753 ) > strtotime( $IX90416 ) ) { $IX90416 = null; $affiliates_options->delete_option( 'affiliate_stats_thru_date' ); } } } } if ( $IX76753 ) { $IX88364 = DateHelper::u2s( $IX76753 ); } if ( $IX90416 ) { $IX73461 = DateHelper::u2s( $IX90416, 24*3600 ); } $IX45863 = $affiliates_db->get_tablename( 'affiliates' ); $IX27204 = $affiliates_db->get_tablename( 'referrals' ); $IX48923 = $affiliates_db->get_tablename( 'hits' ); if ( $IX76753 || $IX90416 || $IX17285 ) { $IX35203 = " WHERE "; } else { $IX35203 = ''; } $IX95967 = array(); if ( $IX76753 && $IX90416 ) { $IX35203 .= " datetime >= %s AND datetime < %s "; $IX95967[] = $IX88364; $IX95967[] = $IX73461; } else if ( $IX76753 ) { $IX35203 .= " datetime >= %s "; $IX95967[] = $IX88364; } else if ( $IX90416 ) { $IX35203 .= " datetime < %s "; $IX95967[] = $IX73461; } if ( $IX17285 ) { if ( $IX76753 || $IX90416 ) { $IX35203 .= " AND "; } $IX35203 .= " h.affiliate_id = %d "; $IX95967[] = $IX17285; } $IX96034 = array( 'visits' => __('訪問次數', 'affiliates' ), 'hits' => __('點擊數', 'affiliates' ), 'referrals' => __( '推薦人', 'affiliates' ), 'ratio' => __('比率', 'affiliates' ) ); $IX98258 = affiliates_get_affiliate_visits( $IX17285, $IX76753, $IX90416 ); $IX31088 = affiliates_get_affiliate_hits( $IX17285, $IX76753, $IX90416 ); $IX41956 = affiliates_get_affiliate_referrals( $IX17285, $IX76753, $IX90416 ); if ( $IX98258 > 0 ) { $IX35927 = round( $IX41956 / $IX98258, self::RATIO_DECIMALS ); } else { $IX35927 = 0; } $IX38547 .= '<div id="" class="affiliate-stats summary">'; $IX38547 .= '
			<table class="wp-list-table widefat fixed" cellspacing="0">
			<thead>
				<tr>
				'; foreach ( $IX96034 as $IX26176 => $IX17465 ) { $IX38547 .= "<th scope='col' class='$IX26176'>$IX17465</th>"; } $IX38547 .= '</tr>
			</thead>
			<tbody>
			'; $IX38547 .= '<tr>'; $IX38547 .= "<td class='visits'>$IX98258</td>"; $IX38547 .= "<td class='hits'>$IX31088</td>"; $IX38547 .= "<td class='referrals'>$IX41956</td>"; $IX38547 .= "<td class='ratio'>$IX35927</td>"; $IX38547 .= '</tr>'; $IX38547 .= '</tbody>'; $IX38547 .= '</table>'; $IX95119 = isset( $options['show_totals'] ) ? ( $options['show_totals'] !== 'false' ) : true; $IX88302 = isset( $options['show_totals_accepted'] ) ? ( $options['show_totals_accepted'] === true || $options['show_totals_accepted'] === 'true' ) : false; $IX58046 = isset( $options['show_totals_pending'] ) ? ( $options['show_totals_pending'] === true || $options['show_totals_pending'] === 'true' ) : false; $IX66681 = isset( $options['show_totals_closed'] ) ? ( $options['show_totals_closed'] === true || $options['show_totals_closed'] === 'true' ) : false; $IX82017 = isset( $options['show_totals_rejected'] ) ? ( $options['show_totals_rejected'] === true || $options['show_totals_rejected'] === 'true' ) : false; if ( $IX95119 && ( $IX88302 || $IX58046 || $IX66681 || $IX82017 ) ) { $IX78367 = ''; if ( $IX76753 && $IX90416 ) { $IX78367 = " AND datetime >= '$IX88364' AND datetime < '$IX73461' "; } else if ( $IX76753 ) { $IX78367 = " AND datetime >= '$IX88364' "; } else if ( $IX90416 ) { $IX78367 = " AND datetime < '$IX73461' "; } $IX42371 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IX27204 WHERE affiliate_id = %d $IX78367 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IX17285, AFFILIATES_REFERRAL_STATUS_ACCEPTED ); $IX16369 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IX27204 WHERE affiliate_id = %d $IX78367 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IX17285, AFFILIATES_REFERRAL_STATUS_PENDING ); $IX34744 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IX27204 WHERE affiliate_id = %d $IX78367 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IX17285, AFFILIATES_REFERRAL_STATUS_CLOSED ); $IX84573 = $affiliates_db->get_objects( "SELECT SUM(amount) AS total, currency_id FROM $IX27204 WHERE affiliate_id = %d $IX78367 AND status = %s AND amount IS NOT NULL AND currency_id IS NOT NULL GROUP BY currency_id", $IX17285, AFFILIATES_REFERRAL_STATUS_REJECTED ); $IX38547 .= '<table class="wp-list-table widefat fixed" cellspacing="0">'; $IX38547 .= '<thead>'; $IX38547 .= '<tr>'; $IX38547 .= "<th scope='col' class='total'>" . esc_html__('全部的', 'affiliates' ) . "</th>"; $IX38547 .= "<th scope='col' class='amount'>" . esc_html__('數量', 'affiliates' ) . "</th>"; $IX38547 .= "<th scope='col' class='currency'>" . esc_html__('貨幣', 'affiliates' ) . "</th>"; $IX38547 .= '</tr>'; $IX38547 .= '</thead>'; $IX38547 .= '<tbody>'; if ( $IX88302 ) { if ( count( $IX42371 ) == 0 ) { $IX42371[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IX42371 as $IX23101 ) { if ( is_numeric( $IX23101->total ) ) { $IX74491 = round( $IX23101->total, affiliates_get_referral_amount_decimals( 'display' ), PHP_ROUND_HALF_UP ); } $IX38547 .= '<tr>'; $IX38547 .= "<td class='total accepted'>" . esc_html__('已接受', 'affiliates' ) . "</td>"; $IX38547 .= sprintf( "<td class='amount'>%s</td>", esc_html( $IX74491 ) ); $IX38547 .= sprintf( "<td class='currency'>%s</td>", $IX23101->currency_id ); $IX38547 .= '</tr>'; } } if ( $IX58046 ) { if ( count( $IX16369 ) == 0 ) { $IX16369[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IX16369 as $IX23101 ) { if ( is_numeric( $IX23101->total ) ) { $IX74491 = round( $IX23101->total, affiliates_get_referral_amount_decimals( 'display' ), PHP_ROUND_HALF_UP ); } $IX38547 .= '<tr>'; $IX38547 .= "<td class='total pending'>" . esc_html__('待辦的', 'affiliates' ) . "</td>"; $IX38547 .= sprintf( "<td class='amount'>%s</td>", esc_html( $IX74491 ) ); $IX38547 .= sprintf( "<td class='currency'>%s</td>", esc_html( $IX23101->currency_id ) ); $IX38547 .= '</tr>'; } } if ( $IX66681 ) { if ( count( $IX34744 ) == 0 ) { $IX34744[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IX34744 as $IX23101 ) { if ( is_numeric( $IX23101->total ) ) { $IX74491 = round( $IX23101->total, affiliates_get_referral_amount_decimals( 'display' ), PHP_ROUND_HALF_UP ); } $IX38547 .= '<tr>'; $IX38547 .= "<td class='total closed'>" . esc_html__('關閉', 'affiliates' ) . "</td>"; $IX38547 .= sprintf( "<td class='amount'>%s</td>", esc_html( $IX74491 ) ); $IX38547 .= sprintf( "<td class='currency'>%s</td>", esc_html( $IX23101->currency_id ) ); $IX38547 .= '</tr>'; } } if ( $IX82017 ) { if ( count( $IX84573 ) == 0 ) { $IX84573[] = (object) array( 'total' => '--', 'currency_id' => '--' ); } foreach ( $IX84573 as $IX23101 ) { if ( is_numeric( $IX23101->total ) ) { $IX74491 = round( $IX23101->total, affiliates_get_referral_amount_decimals( 'display' ), PHP_ROUND_HALF_UP ); } $IX38547 .= '<tr>'; $IX38547 .= "<td class='total rejected'>" . esc_html__('拒絕', 'affiliates' ) . "</td>"; $IX38547 .= sprintf( "<td class='amount'>%s</td>", esc_html( $IX74491 ) ); $IX38547 .= sprintf( "<td class='currency'>%s</td>", esc_html( $IX23101->currency_id ) ); $IX38547 .= '</tr>'; } } $IX38547 .= '</tbody>'; $IX38547 .= '</table>'; } $IX38547 .= '<div class="filters">' . '<label class="description" for="setfilters">' . __('過濾器', 'affiliates' ) . '</label>' . '<form id="setfilters" action="" method="post">' . '<div class="from-date">' . '<label class="from-date-filter" for="from_date">' . __('從', 'affiliates' ) . '</label>' . '<noscript><span class="description mini">' . __( 'Format: YYYY-MM-DD', 'affiliates' ) . '</span></noscript>' . '<input class="datefield from-date-filter" name="from_date" type="text" value="' . esc_attr( $IX76753 ) . '"/>'. '</div>' . '<div class="thru-date">' . '<label class="thru-date-filter" for="thru_date">' . __('Until', 'affiliates' ) . '</label>' . '<noscript><span class="description mini">' . __( 'Format: YYYY-MM-DD', 'affiliates' ) . '</span></noscript>' . '<input class="datefield thru-date-filter" name="thru_date" type="text" class="datefield" value="' . esc_attr( $IX90416 ) . '"/>'. '</div>' . '<div class="submit">' . wp_nonce_field( plugin_basename( __FILE__ ), self::NONCE_FILTERS, true, false ) . '<input type="submit" value="' . __('申請', 'affiliates' ) . '"/>' . '<input type="submit" name="clear_filters" value="' . __('清除', 'affiliates' ) . '"/>' . '<input type="hidden" value="submitted" name="submitted"/>' . '</div>' . '</form>' . '</div>'; $IX38547 .= '</div>'; return $IX38547; }

}
Affiliates_Stats_Renderer_WordPress::init();
