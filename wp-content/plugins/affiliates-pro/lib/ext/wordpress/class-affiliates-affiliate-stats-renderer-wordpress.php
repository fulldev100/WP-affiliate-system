<?php
/**
 * class-affiliates-affiliate-stats-renderer-wordpress.php
 *
 * Copyright (c) 2011 "kento" Karim Rahimpur www.itthinx.com
 *
 * This code is released under the GNU General Public License.
 * See COPYRIGHT.txt and LICENSE.txt.
 *
 * This code is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * This header and all notices must be kept intact.
 *
 * @author Karim Rahimpur
 * @package affiliates-pro
 * @since affiliates-pro 1.0.0
 */

if ( !defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Stats renderer implementation.
 */
class Affiliates_Affiliate_Stats_Renderer_WordPress extends Affiliates_Affiliate_Stats_Renderer {

	const NONCE          = 'affiliate-stats-nonce';
	const NONCE_1        = 'affiliate-stats-nonce-1';
	const NONCE_2        = 'affiliate-stats-nonce-2';
	const NONCE_FILTERS  = 'affiliate-stats-nonce-filters';

	static function render_referrals( $options = array() ) { global $wpdb, $affiliates_options, $affiliates_db; $IX98335 = ''; $IX45569 = Affiliates_Affiliate_WordPress::get_user_affiliate_id(); if ( $IX45569 === false ) { return $IX98335; } $IX88218 = $affiliates_options->get_option( 'affiliate_stats_referrals_from_date', null ); $IX80026 = $affiliates_options->get_option( 'affiliate_stats_referrals_thru_date', null ); if ( isset( $_POST[self::NONCE_FILTERS] ) ) { if ( !wp_verify_nonce( $_POST[self::NONCE_FILTERS], plugin_basename( __FILE__ ) ) ) { wp_die( __( '拒絕訪問。', 'affiliates' ) ); } if ( isset( $_POST['clear_filters'] ) ) { $affiliates_options->delete_option( 'affiliate_stats_referrals_from_date' ); $affiliates_options->delete_option( 'affiliate_stats_referrals_thru_date' ); $IX88218 = null; $IX80026 = null; } else { if ( !empty( $_POST['from_date'] ) ) { $IX88218 = date( 'Y-m-d', strtotime( $_POST['from_date'] ) ); $affiliates_options->update_option( 'affiliate_stats_referrals_from_date', $IX88218 ); } if ( !empty( $_POST['thru_date'] ) ) { $IX80026 = date( 'Y-m-d', strtotime( $_POST['thru_date'] ) ); $affiliates_options->update_option( 'affiliate_stats_referrals_thru_date', $IX80026 ); } if ( $IX88218 && $IX80026 ) { if ( strtotime( $IX88218 ) > strtotime( $IX80026 ) ) { $IX80026 = null; $affiliates_options->delete_option( 'affiliate_stats_referrals_thru_date' ); } } } } if ( $IX88218 ) { $IX45136 = DateHelper::u2s( $IX88218 ); } if ( $IX80026 ) { $IX91971 = DateHelper::u2s( $IX80026, 24*3600 ); } if ( isset( $_POST['row_count'] ) ) { if ( !isset( $_POST[self::NONCE_1] ) || !wp_verify_nonce( $_POST[self::NONCE_1], plugin_basename( __FILE__ ) ) ) { wp_die( __( '拒絕訪問。', 'affiliates' ) ); } } if ( isset( $_POST['paged'] ) ) { if ( !isset( $_POST[self::NONCE_2] ) || !wp_verify_nonce( $_POST[self::NONCE_2], plugin_basename( __FILE__ ) ) ) { wp_die( __( '拒絕訪問。', 'affiliates' ) ); } } $IX29101 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IX29101 = remove_query_arg( 'paged', $IX29101 ); $IX32668 = $affiliates_db->get_tablename( 'affiliates' ); $IX56417 = $affiliates_db->get_tablename( 'referrals' ); $IX81926 = $wpdb->prefix . 'posts'; $IX29175 = isset( $_POST['row_count'] ) ? intval( $_POST['row_count'] ) : 0; if ($IX29175 <= 0) { $IX29175 = $affiliates_options->get_option( 'affiliate_stats_referrals_per_page', self::AFFILIATES_STATS_PER_PAGE ); } else { $affiliates_options->update_option( 'affiliate_stats_referrals_per_page', $IX29175 ); } $IX46037 = isset( $_REQUEST['paged'] ) ? intval( $_REQUEST['paged'] ) : 1; if ( !isset( $_REQUEST['paged'] ) ) { $IX46037 = intval( get_query_var( 'paged' ) ); } if ( $IX46037 < 1 ) { $IX46037 = 1; } $IX19092 = isset( $_GET['orderby'] ) ? $_GET['orderby'] : null; switch ( $IX19092 ) { case 'referral_id' : case 'reference' : case 'datetime' : case 'post_title' : case 'amount' : case 'currency_id' : case 'status' : break; default : $IX19092 = 'datetime'; } $IX87867 = isset( $_GET['order'] ) ? $_GET['order'] : null; switch ( $IX87867 ) { case 'asc' : case 'ASC' : $IX26276 = 'DESC'; break; case 'desc' : case 'DESC' : $IX26276 = 'ASC'; break; default: $IX87867 = 'DESC'; $IX26276 = 'ASC'; } if ( $IX88218 || $IX80026 || $IX45569 ) { $IX40021 = " WHERE "; } else { $IX40021 = ''; } $IX48980 = array(); if ( $IX88218 && $IX80026 ) { $IX40021 .= " datetime >= %s AND datetime < %s "; $IX48980[] = $IX45136; $IX48980[] = $IX91971; } else if ( $IX88218 ) { $IX40021 .= " datetime >= %s "; $IX48980[] = $IX45136; } else if ( $IX80026 ) { $IX40021 .= " datetime < %s "; $IX48980[] = $IX91971; } if ( $IX45569 ) { if ( $IX88218 || $IX80026 ) { $IX40021 .= " AND "; } $IX40021 .= " r.affiliate_id = %d "; $IX48980[] = $IX45569; } $IX84912 = isset( $options['show_accepted'] ) && ( ( $options['show_accepted'] === true ) || ( $options['show_accepted'] == 'true' ) ); $IX15158 = isset( $options['show_pending'] ) && ( ( $options['show_pending'] === true ) || ( $options['show_pending'] == 'true' ) ); $IX48638 = isset( $options['show_closed'] ) && ( ( $options['show_closed'] === true ) || ( $options['show_closed'] == 'true' ) ); $IX81487 = isset( $options['show_rejected'] ) && ( ( $options['show_rejected'] === true ) || ( $options['show_rejected'] == 'true' ) ); $IX66301 = 0; if ( $IX84912 ) { $IX66301++; $IX48980[] = AFFILIATES_REFERRAL_STATUS_ACCEPTED; } if ( $IX15158 ) { $IX66301++; $IX48980[] = AFFILIATES_REFERRAL_STATUS_PENDING; } if ( $IX48638 ) { $IX66301++; $IX48980[] = AFFILIATES_REFERRAL_STATUS_CLOSED; } if ( $IX81487 ) { $IX66301++; $IX48980[] = AFFILIATES_REFERRAL_STATUS_REJECTED; } if ( $IX88218 || $IX80026 || $IX45569 ) { $IX40021 .= " AND "; } switch ( $IX66301 ) { case 1 : $IX40021 .= " r.status = %s "; break; case 2 : $IX40021 .= " r.status IN ( %s, %s ) "; break; case 3 : $IX40021 .= " r.status IN ( %s, %s, %s ) "; break; case 4 : $IX40021 .= " r.status IN ( %s, %s, %s, %s ) "; break; default : $IX40021 .= " r.status = '' "; } do { $IX32712 = false; $IX92342 = ( $IX46037 - 1 ) * $IX29175; $IX42046 = $wpdb->prepare( "SELECT SQL_CALC_FOUND_ROWS r.* " . "FROM $IX56417 r " . "LEFT JOIN $IX32668 a ON r.affiliate_id = a.affiliate_id " . "LEFT JOIN $IX81926 p ON r.post_id = p.ID " . "$IX40021 " . "ORDER BY $IX19092 $IX87867 " . "LIMIT $IX29175 OFFSET $IX92342", $IX48980 ); $IX70707 = $wpdb->get_results( $IX42046, OBJECT ); $IX26030 = intval( $wpdb->get_var( "SELECT FOUND_ROWS()" ) ); if ( $IX26030 > $IX29175 ) { $IX68932 = true; } else { $IX68932 = false; } $IX63930 = max( array( 1, ceil( $IX26030 / $IX29175 ) ) ); if ( $IX46037 > $IX63930 ) { $IX46037 = $IX63930; $IX32712 = true; } } while ( $IX32712 ); $IX98335 .= '<div class="affiliate-stats referrals">'; $IX98335 .= '<div class="page-options">' . '<form id="setrowcount" action="" method="post">' . '<div>' . '<label for="row_count">' . __( '每頁結果', 'affiliates' ) . '</label>' . '<input name="row_count" type="text" size="2" value="' . esc_attr( $IX29175 ) . '" />' . wp_nonce_field( plugin_basename( __FILE__ ), self::NONCE_1, true, false ) . '<input type="submit" value="' . __('申請', 'affiliates' ) . '"/>' . '</div>' . '</form>' . '</div>'; if ( $IX68932 ) { $IX18994 = new Affiliates_Pagination( $IX26030, null, $IX29175 ); $IX98335 .= '<form id="posts-filter" method="post" action="">'; $IX98335 .= '<div>'; $IX98335 .= wp_nonce_field( plugin_basename( __FILE__ ), self::NONCE_2, true, false ); $IX98335 .= '</div>'; $IX98335 .= '<div class="tablenav top">'; $IX98335 .= $IX18994->pagination( 'top' ); $IX98335 .= '</div>'; $IX98335 .= '</form>'; } $IX61135 = isset( $options['show_post'] ) && ( ( $options['show_post'] === true ) || ( $options['show_post'] == 'true' ) ); $IX13792 = isset( $options['show_referral_id'] ) && ( ( $options['show_referral_id'] === true ) || ( $options['show_referral_id'] == 'true' ) ); $IX36254 = isset( $options['show_reference'] ) && ( ( $options['show_reference'] === true ) || ( $options['show_reference'] == 'true' ) ); $IX88733 = array( 'datetime' => __('日期', 'affiliates' ) ); if ( $IX13792 ) { $IX88733['referral_id'] = __( 'ID', 'affiliates' ); } if ( $IX36254 ) { $IX88733['reference'] = __( '參考', 'affiliates' ); } if ( $IX61135 ) { $IX88733['post_title'] = __('郵政', 'affiliates' ); } $IX71817 = isset( $options['show_amount'] ) && ( ( $options['show_amount'] === true ) || ( $options['show_amount'] == 'true' ) ); if ( $IX71817 ) { $IX88733['amount'] = __('數量', 'affiliates' ); } $IX32148 = isset( $options['show_currency_id'] ) && ( ( $options['show_currency_id'] === true ) || ( $options['show_currency_id'] == 'true' ) ); if ( $IX32148 ) { $IX88733['currency_id'] = __('貨幣', 'affiliates' ); } $IX19070 = isset( $options['show_status'] ) && ( ( $options['show_status'] === true ) || ( $options['show_status'] == 'true' ) ); if ( $IX19070 ) { $IX88733['status'] = __('地位', 'affiliates' ); } if ( !empty( $options['data'] ) ) { $IX88733['data'] = __( 'Details', 'affiliates' ); } $IX88733 = apply_filters( 'affiliates_affiliate_stats_renderer_column_display_names', $IX88733 ); $IX52680 = count( $IX88733 ); $IX98335 .= '<table class="referrals" cellspacing="0" cellpadding="0">'; $IX98335 .= '<thead>'; $IX98335 .= '<tr>'; foreach ( $IX88733 as $IX80592 => $IX96805 ) { $IX47439 = array( 'orderby' => $IX80592, 'order' => $IX26276 ); if ( in_array( $IX80592, array( 'referral_id', 'reference', 'datetime', 'post_title', 'amount', 'currency_id', 'status' ) ) ) { $IX97192 = ""; if ( strcmp( $IX80592, $IX19092 ) == 0 ) { $IX89883 = strtolower( $IX87867 ); $IX97192 = "$IX80592 manage-column sorted $IX89883"; } else { $IX97192 = "$IX80592 manage-column sortable"; } $IX96805 = '<a href="' . esc_url( add_query_arg( $IX47439, $IX29101 ) ) . '"><span>' . $IX96805 . '</span><span class="sorting-indicator"></span></a>'; $IX98335 .= "<th scope='col' class='$IX97192'>$IX96805</th>"; } else { $IX98335 .= "<th scope='col' class='$IX80592'>$IX96805</th>"; } } $IX98335 .= '</tr>'; $IX98335 .= '</thead>'; $IX98335 .= '<tbody>'; if ( count( $IX70707 ) > 0 ) { $IX27132 = array(); if ( !empty( $options['data'] ) ) { $IX63375 = explode(",", $options['data'] ); if ( !empty( $IX63375 ) ) { foreach( $IX63375 as $IX15100 ) { $IX27132[] = trim( $IX15100 ); } } } $IX58875 = array( AFFILIATES_REFERRAL_STATUS_ACCEPTED => __('已接受', AFFILIATES_PLUGIN_DOMAIN ), AFFILIATES_REFERRAL_STATUS_CLOSED => __('關閉', AFFILIATES_PLUGIN_DOMAIN ), AFFILIATES_REFERRAL_STATUS_PENDING => __('待辦的', AFFILIATES_PLUGIN_DOMAIN ), AFFILIATES_REFERRAL_STATUS_REJECTED => __('拒絕', AFFILIATES_PLUGIN_DOMAIN ), ); for ( $IX46686 = 0; $IX46686 < count( $IX70707 ); $IX46686++ ) { $IX26645 = $IX70707[$IX46686]; $IX98335 .= '<tr class="details-referrals ' . ( $IX46686 % 2 == 0 ? 'even' : 'odd' ) . '">'; foreach( $IX88733 as $IX80592 => $IX96805 ) { switch( $IX80592 ) { case 'referral_id' : $IX98335 .= '<td class="referral_id">' . wp_filter_nohtml_kses( $IX26645->referral_id ) . '</td>'; break; case 'reference' : $IX98335 .= '<td class="reference">' . wp_filter_nohtml_kses( $IX26645->reference ) . '</td>'; break; case 'datetime' : $IX98335 .= '<td class="datetime">' . DateHelper::s2u( $IX26645->datetime ) . '</td>'; break; case 'post_title' : if ( $IX61135 ) { if ( !empty( $IX26645->post_id ) ) { $IX16763 = affiliates_get_referral_post_permalink( $IX26645 ); $IX36035 = affiliates_get_referral_post_title( $IX26645 ); $IX98335 .= '<td class="post_title">'; if ( !empty( $IX16763 ) ) { $IX98335 .= sprintf( '<a href="%s" target="_blank">%s</a>', esc_url( $IX16763 ), stripslashes( wp_filter_nohtml_kses( $IX36035 ) ) ); } else { $IX98335 .= stripslashes( wp_filter_nohtml_kses( $IX36035 ) ); } $IX98335 .= '</td>'; } else { $IX98335 .= '<td class="post_title"></td>'; } } break; case 'amount' : if ( $IX71817 ) { $IX50379 = round( $IX26645->amount, affiliates_get_referral_amount_decimals( 'display' ), PHP_ROUND_HALF_UP ); $IX98335 .= '<td class="amount">' . esc_html( $IX50379 ) . '</td>'; } break; case 'currency_id' : if ( $IX32148 ) { $IX98335 .= '<td class="currency_id">' . esc_html( $IX26645->currency_id ) . '</td>'; } break; case 'status' : if ( $IX19070 ) { $IX98335 .= '<td class="status">' . ( isset( $IX58875[$IX26645->status] ) ? $IX58875[$IX26645->status] : esc_attr( $IX26645->status ) ) . '</td>'; } break; case 'data' : if ( !empty( $IX27132 ) ) { $IX38350 = $IX26645->data; if ( !empty( $IX38350 ) ) { $IX38350 = unserialize( $IX38350 ); } else { $IX38350 = array(); } $IX38350 = apply_filters( 'affiliates_affiliate_stats_renderer_data', $IX38350, $IX26645 ); $IX98335 .= '<td>'; if ( $IX38350 ) { $IX63913 = ''; if ( is_array( $IX38350 ) ) { foreach ( $IX27132 as $IX80592 ) { if ( isset( $IX38350[$IX80592] ) ) { $IX95849 = $IX38350[$IX80592]; $IX18175 = __( $IX95849['title'], $IX95849['domain'] ); $IX14480 = $IX95849['value']; $IX63913 .= '<div class="referral-data-title">'; $IX63913 .= stripslashes( wp_filter_nohtml_kses( $IX18175 ) ); $IX63913 .= '</div>'; $IX63913 .= '<div class="referral-data-value">'; $IX63913 .= stripslashes( wp_filter_nohtml_kses( $IX14480 ) ); $IX63913 .= '</div>'; } } } else { if ( !empty( $IX27132 ) && ( $IX27132[0] == 'data' ) ) { $IX63913 .= '<div class="referral-data-value">'; $IX63913 .= stripslashes( wp_filter_nohtml_kses( $IX38350 ) ); $IX63913 .= '</div>'; } } $IX98335 .= apply_filters( 'affiliates_affiliate_stats_renderer_data_output', $IX63913, $IX26645 ); } $IX98335 .= '</td>'; } break; default : $IX98335 .= sprintf( '<td class="%s">', esc_attr( $IX80592 ) ); $IX98335 .= apply_filters( 'affiliates_affiliate_stats_renderer_column_output', '', $IX80592, $IX26645 ); $IX98335 .= '</td>'; } } $IX98335 .= '</tr>'; } } else { $IX98335 .= '<tr><td colspan="' . $IX52680 . '">' . __('沒有結果。', 'affiliates' ) . '</td></tr>'; } $IX98335 .= '</tbody>'; $IX98335 .= '</table>'; if ( $IX68932 ) { $IX18994 = new Affiliates_Pagination( $IX26030, null, $IX29175 ); $IX98335 .= '<div class="tablenav bottom">'; $IX98335 .= $IX18994->pagination( 'bottom' ); $IX98335 .= '</div>'; } $IX98335 .= '<div class="filters">' . '<label class="description" for="setfilters">' . __('過濾器', 'affiliates' ) . '</label>' . '<form id="setfilters" action="" method="post">' . '<div class="from-date">' . '<label class="from-date-filter" for="from_date">' . __('從', 'affiliates' ) . '</label>' . '<input class="datefield from-date-filter" name="from_date" type="text" value="' . esc_attr( $IX88218 ) . '"/>'. '</div>' . '<div class="thru-date">' . '<label class="thru-date-filter" for="thru_date">' . __('Until', 'affiliates' ) . '</label>' . '<input class="datefield thru-date-filter" name="thru_date" type="text" class="datefield" value="' . esc_attr( $IX80026 ) . '"/>'. '</div>' . '<div class="submit">' . wp_nonce_field( plugin_basename( __FILE__ ), self::NONCE_FILTERS, true, false ) . '<input type="submit" value="' . __('申請', 'affiliates' ) . '"/>' . '<input type="submit" name="clear_filters" value="' . __('清除', 'affiliates' ) . '"/>' . '<input type="hidden" value="submitted" name="submitted"/>' . '</div>' . '</form>' . '</div>'; $IX98335 .= '</div>'; return $IX98335; }

}

