<?php
/**
 * class-affiliates-traffic-renderer-wordpress.php
 *
 * Copyright (c) 2011-2017 "kento" Karim Rahimpur www.itthinx.com
 *
 * This code is released under the GNU General Public License.
 * See COPYRIGHT.txt and LICENSE.txt.
 *
 * This code is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * This header and all notices must be kept intact.
 *
 * @author Karim Rahimpur
 * @package affiliates-pro
 * @since affiliates-pro 2.17.0
 */

if ( !defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Traffic-renderer, platform-dependent extension.
 */
class Affiliates_Traffic_Renderer_WordPress extends Affiliates_Traffic_Renderer {

	/**
	 * Class initialization.
	 */
	public static function init() { add_shortcode( 'affiliates_traffic', array( __CLASS__, 'affiliates_traffic' ) ); }

	public static function affiliates_traffic( $atts, $content = null ) { $IX37429 = ''; wp_enqueue_script( 'datepicker' ); wp_enqueue_script( 'datepickers' ); wp_enqueue_style( 'smoothness' ); wp_enqueue_style( 'my affiliate pro' ); $IX39639 = shortcode_atts( self::$traffic_defaults, $atts ); foreach( self::$traffic_defaults as $IX44399 => $IX54210 ) { switch( $IX44399 ) { case 'show_dates' : case 'show_visits' : case 'show_hits' : case 'show_referrals' : case 'show_src_uris' : case 'show_dest_uris' : case 'show_filters' : case 'show_pagination' : if ( isset( $IX39639[$IX44399] ) ) { if ( is_string( $IX39639[$IX44399] ) ) { $IX47125 = strtolower( trim( $IX39639[$IX44399] ) ); switch( $IX47125 ) { case 'true' : case 'yes' : $IX39639[$IX44399] = true; break; case 'false' : case 'no' : $IX39639[$IX44399] = false; break; default : $IX39639[$IX44399] = $IX54210; } } else { $IX39639[$IX44399] = $IX39639[$IX44399] ? true : false; } } break; case 'src_uri_maxlength' : case 'dest_uri_maxlength' : case 'per_page' : $IX47125 = trim( $IX39639[$IX44399] ); if ( !empty( $IX47125 ) ) { $IX39639[$IX44399] = max( 0, intval( $IX47125 ) ); } else { $IX39639[$IX44399] = 0; } break; case 'status' : if ( is_string( $IX39639[$IX44399] ) ) { $IX39639[$IX44399] = array_map( 'trim', explode( ',', $IX39639[$IX44399] ) ); } $IX99633 = array(); foreach( $IX39639[$IX44399] as $IX35187 ) { if ( $IX35187 = Affiliates_Utility::verify_referral_status_transition( $IX35187, $IX35187 ) ) { $IX99633[] = $IX35187; } } if (!empty( $IX99633 ) ) { $IX39639[$IX44399] = $IX99633; } else { $IX39639[$IX44399] = self::$traffic_defaults[$IX44399]; } break; } } if ( $IX39639['per_page'] <= 0 ) { $IX39639['per_page'] = self::$traffic_defaults['per_page']; } $IX37429 = self::render_affiliate_traffic( $IX39639 ); return $IX37429; }

	public static function render_affiliate_traffic( $options = array() ) { global $wpdb, $affiliates_options, $affiliates_db; $options = shortcode_atts( self::$traffic_defaults, $options ); $IX62287 = array(); if ( $options['show_dates'] ) { $IX62287['date'] = __('日期', 'affiliates' ); } if ( $options['show_visits'] ) { $IX62287['visits'] = __('訪問次數', 'affiliates' ); } if ( $options['show_hits'] ) { $IX62287['hits'] = __('點擊數', 'affiliates' ); } if ( $options['show_referrals'] ) { $IX62287['referrals'] = __( '推薦人', 'affiliates' ); } if ( $options['show_src_uris'] ) { $IX62287['src_uri'] = __('源 URI', 'affiliates' ); } if ( $options['show_dest_uris'] ) { $IX62287['dest_uri'] = __('登陸 URI', 'affiliates' ); } if ( empty( $options['affiliate_id'] ) || $options['affiliate_id'] === null ) { $IX46485 = get_current_user_id(); $IX29436 = null; if ( $IX46485 ) { $IX15217 = affiliates_get_user_affiliate( $IX46485 ); if ( !empty( $IX15217 ) ) { $IX29436 = array_shift( $IX15217 ); } } } else { $IX33796 = affiliates_get_affiliate( $options['affiliate_id'] ); if ( $IX33796 === null || $IX33796['status'] !== AFFILIATES_AFFILIATE_STATUS_ACTIVE ) { $IX29436 = null; } else { $IX29436 = $IX33796['affiliate_id']; } } $IX56617 = ''; if ( !$IX29436 ) { return $IX56617; } $IX53069 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IX53069 = remove_query_arg( 'uris_paged', $IX53069 ); $IX53069 = remove_query_arg( 'clear_filters', $IX53069 ); $IX53069 = remove_query_arg( 'apply_filters', $IX53069 ); $IX27034 = isset( $_REQUEST['from_date'] ) ? trim( $_REQUEST['from_date'] ) : null; $IX27751 = isset( $_REQUEST['thru_date'] ) ? trim( $_REQUEST['thru_date'] ) : null; $IX21376 = isset( $_REQUEST['src_uri'] ) ? trim( $_REQUEST['src_uri'] ) : null; $IX38814 = isset( $_REQUEST['dest_uri'] ) ? trim( $_REQUEST['dest_uri'] ) : null; $IX52395 = isset( $_REQUEST['min_referrals'] ) ? trim( $_REQUEST['min_referrals'] ) : null; if ( isset( $_REQUEST['clear_filters'] ) ) { unset( $_REQUEST['from_date'] ); unset( $_REQUEST['thru_date'] ); unset( $_REQUEST['src_uri'] ); unset( $_REQUEST['dest_uri'] ); unset( $_REQUEST['min_referrals'] ); $IX27034 = null; $IX27751 = null; $IX21376 = null; $IX38814 = null; $IX52395 = null; $IX53069 = remove_query_arg( 'from_date', $IX53069 ); $IX53069 = remove_query_arg( 'thru_date', $IX53069 ); $IX53069 = remove_query_arg( 'src_uri', $IX53069 ); $IX53069 = remove_query_arg( 'dest_uri', $IX53069 ); $IX53069 = remove_query_arg( 'min_referrals', $IX53069 ); } else { if ( !empty( $_REQUEST['from_date'] ) ) { $IX27034 = date( 'Y-m-d', strtotime( $_REQUEST['from_date'] ) ); } else { $IX27034 = null; } if ( !empty( $_REQUEST['thru_date'] ) ) { $IX27751 = date( 'Y-m-d', strtotime( $_REQUEST['thru_date'] ) ); } else { $IX27751 = null; } if ( $IX27034 && $IX27751 ) { if ( strtotime( $IX27034 ) > strtotime( $IX27751 ) ) { $IX27751 = null; } } if ( !empty( $_REQUEST['src_uri'] ) ) { $IX21376 = trim( $_REQUEST['src_uri'] ); } else if ( isset( $_REQUEST['src_uri'] ) ) { $IX21376 = null; } if ( !empty( $_REQUEST['dest_uri'] ) ) { $IX38814 = trim( $_REQUEST['dest_uri'] ); } else if ( isset( $_REQUEST['dest_uri'] ) ) { $IX38814 = null; } if ( !empty( $_REQUEST['min_referrals'] ) ) { $IX52395 = max( 0, intval( $_REQUEST['min_referrals'] ) ); } else if ( isset( $_REQUEST['min_referrals'] ) ) { $IX52395 = null; } } $IX17786 = _affiliates_get_tablename( 'affiliates' ); $IX66163 = _affiliates_get_tablename( 'referrals' ); $IX32461 = _affiliates_get_tablename( 'hits' ); $IX41481 = _affiliates_get_tablename( 'uris' ); $IX85790 = isset( $_REQUEST['row_count'] ) ? intval( $_REQUEST['row_count'] ) : 0; if ($IX85790 <= 0) { $IX85790 = $options['per_page']; } $IX86393 = isset( $_REQUEST['uris_paged'] ) ? intval( $_REQUEST['uris_paged'] ) : 0; if ( $IX86393 < 0 ) { $IX86393 = 0; } $IX17486 = isset( $_GET['orderby'] ) ? $_GET['orderby'] : null; switch ( $IX17486 ) { case 'date' : case 'visits' : case 'hits' : case 'referrals' : case 'src_uri' : case 'dest_uri' : break; default: $IX17486 = 'date'; } $IX87407 = isset( $_GET['order'] ) ? $_GET['order'] : null; switch ( $IX87407 ) { case 'asc' : case 'ASC' : $IX84489 = 'DESC'; break; case 'desc' : case 'DESC' : $IX84489 = 'ASC'; break; default: $IX87407 = 'DESC'; $IX84489 = 'ASC'; } $IX15179 = " WHERE 1=%d "; $IX99516 = array( 1 ); if ( $IX27034 ) { $IX63025 = DateHelper::u2s( $IX27034 ); } if ( $IX27751 ) { $IX28480 = DateHelper::u2s( $IX27751, 24*3600 ); } if ( $IX27034 && $IX27751 ) { $IX15179 .= " AND h.datetime >= %s AND h.datetime <= %s "; $IX99516[] = $IX63025; $IX99516[] = $IX28480; } else if ( $IX27034 ) { $IX15179 .= " AND h.datetime >= %s "; $IX99516[] = $IX63025; } else if ( $IX27751 ) { $IX15179 .= " AND h.datetime < %s "; $IX99516[] = $IX28480; } $IX15179 .= " AND h.affiliate_id = %d "; $IX99516[] = $IX29436; if ( $IX21376 ) { $IX15179 .= " AND su.uri LIKE %s "; $IX99516[] = '%' . $wpdb->esc_like( $IX21376 ) . '%'; } if ( $IX38814 ) { $IX15179 .= " AND du.uri LIKE %s "; $IX99516[] = '%' . $wpdb->esc_like( $IX38814 ) . '%'; } $IX23609 = ''; if ( $IX52395 ) { $IX23609 = " HAVING COUNT(r.hit_id) >= " . intval( $IX52395 ). " "; } $IX84136 = ''; if ( is_array( $options['status'] ) && count( $options['status'] ) > 0 ) { $IX84136 = " AND ( r.status IS NULL OR r.status IN ('" . implode( "','", array_map( 'esc_sql', $options['status'] ) ) . "') ) "; $IX15179 .= $IX84136; } $IX76135 = $IX85790; $IX62226 = $IX86393; $IX62946 = $IX76135 * $IX62226; $IX13336 = $wpdb->prepare( "SELECT SQL_CALC_FOUND_ROWS " . "h.*, " . "a.name, " . "su.uri src_uri, " . "du.uri dest_uri, " . "COUNT(distinct h.ip) visits, " . "COUNT(*) hits, " . "COUNT(r.hit_id) referrals " . "FROM $IX32461 h " . "LEFT JOIN $IX17786 a ON h.affiliate_id = a.affiliate_id " . "LEFT JOIN $IX41481 su ON h.src_uri_id = su.uri_id " . "LEFT JOIN $IX41481 du ON h.dest_uri_id = du.uri_id " . "LEFT JOIN $IX66163 r ON r.hit_id = h.hit_id " . "$IX15179 " . "GROUP BY h.affiliate_id, h.date, su.uri_id, du.uri_id " . "$IX23609 " . "ORDER BY $IX17486 $IX87407 " . "LIMIT $IX85790 OFFSET $IX62946", $IX99516 ); $IX86488 = $wpdb->get_results( $IX13336, OBJECT ); $IX88644 = intval( $wpdb->get_var( "SELECT FOUND_ROWS()" ) ); if ( $IX88644 > $IX85790 ) { $IX32104 = true; } else { $IX32104 = false; } $IX56617 .= '<div class="affiliates-traffic">'; if ( $options['show_filters'] ) { $IX56617 .= '<div class="filters">'; $IX56617 .= '<label class="description" for="setfilters">' . __('過濾器', 'affiliates' ) . '</label>'; $IX56617 .= '<form id="setfilters" action="" method="get">'; if ( isset( $IX62287['date'] ) ) { $IX56617 .= '<div class="filter-section">'; $IX56617 .= '<label class="from-date-filter">'; $IX56617 .= __('從', 'affiliates' ); $IX56617 .= ' '; $IX56617 .= '<input class="datefield from-date-filter" name="from_date" type="text" value="' . esc_attr( $IX27034 ) . '"/>'; $IX56617 .= '</label>'; $IX56617 .= ' '; $IX56617 .= '<label class="thru-date-filter">'; $IX56617 .= __('直到', 'affiliates' ); $IX56617 .= ' '; $IX56617 .= '<input class="datefield thru-date-filter" name="thru_date" type="text" class="datefield" value="' . esc_attr( $IX27751 ) . '"/>'; $IX56617 .= '</label>'; $IX56617 .= '</div>'; } if ( isset( $IX62287['src_uri'] ) || isset( $IX62287['dest_uri'] ) ) { $IX56617 .= '<div class="filter-section">'; } if ( isset( $IX62287['src_uri'] ) ) { $IX56617 .= '<label class="src-uri-filter">'; $IX56617 .= __('源 URI', 'affiliates' ); $IX56617 .= ' '; $IX56617 .= '<input class="src-uri-filter" name="src_uri" type="text" value="' . esc_attr( stripslashes( $IX21376 !== null ? $IX21376 : '' ) ) . '"/>'; $IX56617 .= '</label>'; $IX56617 .= ' '; } if ( isset( $IX62287['dest_uri'] ) ) { $IX56617 .= '<label class="dest-uri-filter">'; $IX56617 .= __('登陸 URI', 'affiliates' ); $IX56617 .= ' '; $IX56617 .= '<input class="dest-uri-filter" name="dest_uri" type="text" value="' . esc_attr( stripslashes( $IX38814 !== null ? $IX38814 : '' ) ) . '"/>'; $IX56617 .= '</label>'; } if ( isset( $IX62287['src_uri'] ) || isset( $IX62287['dest_uri'] ) ) { $IX56617 .= '</div>'; } if ( isset( $IX62287['referrals'] ) ) { $IX56617 .= '<div class="filter-section">'; $IX56617 .= '<label class="min-referrals-filter">'; $IX56617 .= __( '推薦人', 'affiliates' ); $IX56617 .= ' '; $IX56617 .= sprintf( '<input class="input-text min-referrals-filter" title="%s" name="min_referrals" type="number" value="%d" min="0"/>', esc_attr( __( 'Minimum number of referrals', 'affiliates' ) ), esc_attr( $IX52395 ) ); $IX56617 .= '</label>'; $IX56617 .= '</div>'; } $IX56617 .= sprintf( '<input type="hidden" name="row_count" value="%s" />', esc_attr( $IX85790 ) ); $IX56617 .= '<div class="filter-buttons">'; $IX56617 .= '<input class="button apply-button" type="submit" name="apply_filters" value="' . __('申請', 'affiliates' ) . '"/>'; $IX56617 .= '<input class="button clear-button" type="submit" name="clear_filters" value="' . __('清除', 'affiliates' ) . '"/>'; $IX56617 .= '</div>'; $IX56617 .= '</form>'; $IX56617 .= '</div>'; } if ( $options['show_pagination'] ) { $IX56617 .= '<div class="page-options">'; $IX56617 .= '<form id="setrowcount" action="" method="get">'; $IX56617 .= '<label class="row-count">'; $IX56617 .= __('每頁結果', 'affiliates' ); $IX56617 .= ' '; $IX56617 .= '<input name="row_count" type="text" size="2" value="' . esc_attr( $IX85790 ) .'" />'; $IX56617 .= ' '; $IX56617 .= '<input class="button" type="submit" value="' . __('申請', 'affiliates' ) . '"/>'; $IX56617 .= '</label>'; $IX56617 .= sprintf( '<input type="hidden" name="from_date" value="%s" />', esc_attr( $IX27034 ) ); $IX56617 .= sprintf( '<input type="hidden" name="thru_date" value="%s" />', esc_attr( $IX27751 ) ); $IX56617 .= sprintf( '<input type="hidden" name="src_uri" value="%s" />', esc_attr( stripslashes( $IX21376 !== null ? $IX21376 : '' ) ) ); $IX56617 .= sprintf( '<input type="hidden" name="dest_uri" value="%s" />', esc_attr( stripslashes( $IX38814 !== null ? $IX38814 : '' ) ) ); $IX56617 .= sprintf( '<input type="hidden" name="min_referrals" value="%s" />', esc_attr( $IX52395 ) ); $IX56617 .= '</form>'; $IX56617 .= '</div>'; if ( $IX32104 ) { require_once AFFILIATES_CORE_LIB . '/class-affiliates-pagination.php'; $IX57023 = new Affiliates_Pagination( $IX88644, null, $IX85790, 'uris_paged' ); $IX56617 .= '<form id="posts-filter" method="get" action="">'; $IX56617 .= '<div>'; $IX56617 .= sprintf( '<input type="hidden" name="from_date" value="%s" />', esc_attr( $IX27034 ) ); $IX56617 .= sprintf( '<input type="hidden" name="thru_date" value="%s" />', esc_attr( $IX27751 ) ); $IX56617 .= sprintf( '<input type="hidden" name="src_uri" value="%s" />', esc_attr( stripslashes( $IX21376 ) ) ); $IX56617 .= sprintf( '<input type="hidden" name="dest_uri" value="%s" />', esc_attr( stripslashes( $IX38814 ) ) ); $IX56617 .= sprintf( '<input type="hidden" name="min_referrals" value="%s" />', esc_attr( $IX52395 ) ); $IX56617 .= '</div>'; $IX56617 .= '<div class="tablenav top">'; $IX56617 .= $IX57023->pagination( 'top' ); $IX56617 .= '</div>'; $IX56617 .= '</form>'; } } $IX89807 = DateHelper::getServerDateTimeZone(); $IX50076['date'] = sprintf( __( "* Date is given for the server's time zone : %s, which has an offset of %s hours with respect to GMT.", 'affiliates' ), $IX89807->getName(), $IX89807->getOffset( new DateTime() ) / 3600.0 ); $IX50076['referrals'] = __( 'The number of corresponding referrals or conversions.', 'affiliates' ); $IX50076['visits'] = __( 'The number of unique visits.', 'affiliates' ); $IX50076['hits'] = __( 'The number of hits or clicks.', 'affiliates' ); $IX50076['src_uri'] = __( 'Where the traffic originated from.', 'affiliates' ); $IX50076['dest_uri'] = __( 'Where the traffic lead to.', 'affiliates' ); $IX56617 .= '<table class="wp-list-table widefat fixed" cellspacing="0">'; $IX56617 .= '<thead>'; $IX56617 .= '<tr>'; foreach ( $IX62287 as $IX46665 => $IX93294 ) { $IX54139 = array( 'orderby' => $IX46665, 'order' => $IX84489 ); $IX39009 = ''; $IX27389 = ''; if ( strcmp( $IX46665, $IX17486 ) == 0 ) { $IX67453 = strtolower( $IX87407 ); $IX39009 = "$IX46665 manage-column sorted $IX67453"; switch( $IX67453 ) { case 'asc' : $IX27389 = ' &uarr;'; break; case 'desc' : $IX27389 = ' &darr;'; break; } } else { $IX39009 = "$IX46665 manage-column sortable"; } $IX93294 = sprintf( '<a href="%s" title="%s"><span>%s%s</span><span class="sorting-indicator"></span></a>', esc_url( add_query_arg( $IX54139, $IX53069 ) ), !empty( $IX50076[$IX46665] ) ? esc_attr( $IX50076[$IX46665] ) : '', esc_html( $IX93294 ), esc_html( $IX27389 ) ); $IX56617 .= "<th scope='col' class='$IX39009'>$IX93294</th>"; } $IX56617 .= '</tr>'; $IX56617 .= '</thead>'; $IX56617 .= '<tbody>'; if ( count( $IX86488 ) > 0 ) { for ( $IX45343 = 0; $IX45343 < count( $IX86488 ); $IX45343++ ) { $IX69054 = $IX86488[$IX45343]; $IX56617 .= '<tr class=" ' . ( $IX45343 % 2 == 0 ? 'even' : 'odd' ) . '">'; $IX56617 .= isset( $IX62287['date'] ) ? "<td class='date'>$IX69054->date</td>" : ''; $IX56617 .= isset( $IX62287['visits'] ) ? "<td class='visits'>$IX69054->visits</td>" : ''; $IX56617 .= isset( $IX62287['hits'] ) ? "<td class='hits'>$IX69054->hits</td>" : ''; $IX56617 .= isset( $IX62287['referrals'] ) ? "<td class='referrals'>$IX69054->referrals</td>" : ''; $IX82125 = ''; $IX13311 = ''; $IX21376 = $IX69054->src_uri; if ( $options['src_uri_maxlength'] && $IX69054->src_uri !== null && (strlen( $IX69054->src_uri ) > $options['src_uri_maxlength'] ) ) { $IX21376 = substr( $IX69054->src_uri, 0, $options['src_uri_maxlength'] ) . '&hellip;'; $IX82125 = 'truncated'; } $IX56617 .= isset( $IX62287['src_uri'] ) ? sprintf( "<td class='src-uri %s'><span title='%s'>%s</span></td>", esc_attr( $IX82125 ), esc_attr( $IX69054->src_uri ), esc_html( $IX21376 ) ) : ''; $IX38814 = $IX69054->dest_uri; if ( $options['dest_uri_maxlength'] && $IX69054->dest_uri !== null && (strlen( $IX69054->dest_uri ) > $options['dest_uri_maxlength'] ) ) { $IX38814 = substr( $IX69054->dest_uri, 0, $options['dest_uri_maxlength'] ) . '&hellip;'; $IX13311 = 'truncated'; } $IX56617 .= isset( $IX62287['dest_uri'] ) ? sprintf( "<td class='dest-uri %s'><span title='%s'>%s</span></td>", esc_attr( $IX13311 ), esc_attr( $IX69054->dest_uri ), esc_html( $IX38814 ) ) : ''; $IX56617 .= '</tr>'; } } else { $IX56617 .= '<tr><td colspan="' . sizeof( $IX62287 ) .'">' . __('沒有結果。', 'affiliates' ) . '</td></tr>'; } $IX56617 .= '</tbody>'; $IX56617 .= '</table>'; if ( $options['show_pagination'] ) { if ( $IX32104 ) { require_once AFFILIATES_CORE_LIB . '/class-affiliates-pagination.php'; $IX57023 = new Affiliates_Pagination( $IX88644, null, $IX85790, 'uris_paged' ); $IX56617 .= '<div class="tablenav bottom">'; $IX56617 .= $IX57023->pagination( 'bottom' ); $IX56617 .= '</div>'; } } $IX56617 .= '</div>'; return $IX56617; }
}
Affiliates_Traffic_Renderer_WordPress::init();
