<?php
/**
 * class-affiliates-affiliate-wordpress.php
 *
 * Copyright (c) 2010, 2011 "kento" Karim Rahimpur www.itthinx.com
 *
 * This code is released under the GNU General Public License.
 * See COPYRIGHT.txt and LICENSE.txt.
 *
 * This code is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * This header and all notices must be kept intact.
 *
 * @author Karim Rahimpur
 * @package affiliates-pro
 * @since affiliates-pro 1.0.0
 */

if ( !defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Provides affiliate editing form and update functions.
 */
class Affiliates_Affiliate_WordPress extends Affiliates_Affiliate {

	public static function get_user_affiliate_id( $user_id = null ) { global $affiliates_db; $IX68857 = false; $IX49651 = null; if ( $user_id === null ) { if ( is_user_logged_in() ) { $IX49651 = wp_get_current_user(); } } else { $IX49651 = get_user_by( 'id', $user_id ); } if ( $IX49651 ) { $IX68857 = parent::get_user_affiliate_id( $IX49651->ID ); } return $IX68857; }

	public static function update_name( $affiliate_id, $name ) { global $affiliates_db; $IX97690 = false; $IX84407 = self::get_affiliate( $affiliate_id ); if ( $IX84407 ) { $name = Affiliates_Utility::filter( $name ); if ( !empty( $name ) ) { $IX13737 = $IX84407->name; if ( $IX13737 != $name ) { $IX46238 = $affiliates_db->get_tablename( 'affiliates' ); if ( $affiliates_db->query( "UPDATE $IX46238 SET name = %s WHERE affiliate_id = %d", $name, $affiliate_id ) ) { $IX97690 = $name; do_action( 'affiliates_updated_name', $affiliate_id, $IX13737, $name ); do_action( 'affiliates_updated_affiliate', intval( $affiliate_id ) ); } } } } return $IX97690; }

	public static function update_email( $affiliate_id, $email ) { global $affiliates_db; $IX91648 = false; $IX37277 = self::get_affiliate( $affiliate_id ); if ( $IX37277 ) { if ( $email = Affiliates_Validator::validate_email( $email ) ) { $IX61156 = $IX37277->email; if ( $IX61156 != $email ) { $IX11464 = $affiliates_db->get_tablename( 'affiliates' ); if ( $affiliates_db->query( "UPDATE $IX11464 SET email = %s WHERE affiliate_id = %d", $email, $affiliate_id ) ) { $IX91648 = $email; do_action( 'affiliates_updated_email', $affiliate_id, $IX61156, $email ); do_action( 'affiliates_updated_affiliate', intval( $affiliate_id ) ); } } } } return $IX91648; }

	public static function update_attribute( $affiliate_id, $key, $value ) { global $affiliates_db; $IX17854 = false; $IX70823 = self::get_affiliate( $affiliate_id ); if ( $IX70823 && Affiliates_Attributes::validate_key( $key ) ) { if ( $value = Affiliates_Attributes::validate_value( $key, $value ) ) { $IX47361 = $affiliates_db->get_tablename( 'affiliates_attributes' ); $IX11702 = $affiliates_db->get_value( "SELECT attr_value FROM $IX47361 WHERE affiliate_id = %d AND attr_key = %s", $affiliate_id, $key ); if ( $IX11702 != $value ) { if ( $affiliates_db->query( "INSERT INTO $IX47361 SET affiliate_id = %d, attr_key = %s, attr_value = %s ON DUPLICATE KEY UPDATE attr_value = %s", $affiliate_id, $key, $value, $value ) ) { $IX17854 = $value; do_action( 'affiliates_updated_attribute', $affiliate_id, $key, $IX11702, $value ); do_action( 'affiliates_updated_affiliate', intval( $affiliate_id ) ); } } } } return $IX17854; }

	function edit( $affiliate_id ) { global $wpdb; if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( '拒絕訪問。', 'affiliates' ) ); } $IX39558 = affiliates_get_affiliate( intval( $affiliate_id ) ); if ( empty( $IX39558 ) ) { wp_die( __('沒有這樣的附屬機構。', 'affiliates' ) ); } $IX82000 = _affiliates_get_tablename( 'affiliates_users' ); $IX65890 = null; $IX35449 = ''; $IX33892 = ''; $IX52883 = $wpdb->get_var( $wpdb->prepare( "SELECT user_id FROM $IX82000 WHERE affiliate_id = %d", intval( $affiliate_id ) ) ); if ( $IX52883 !== null ) { $IX65890 = get_user_by( 'id', intval( $IX52883 ) ); if ( $IX65890 ) { if ( current_user_can( 'edit_user', $IX65890->ID ) ) { $IX35449 = sprintf( __( '編輯 %s', 'affiliates' ) , '<a target="_blank" href="' . esc_url( "user-edit.php?user_id=$IX65890->ID" ) . '">' . $IX65890->user_login . '</a>' ); } require_once AFFILIATES_CORE_LIB . '/class-affiliates-settings.php'; require_once AFFILIATES_CORE_LIB . '/class-affiliates-settings-registration.php'; $IX76421 = Affiliates_Settings_Registration::get_fields(); foreach( Affiliates_Registration::get_skip_meta_fields() as $IX63997 ) { unset( $IX76421[$IX63997] ); } foreach( $IX76421 as $IX14214 => $IX17752 ) { if ( $IX17752['enabled'] ) { $IX33892 .= '<div class="field">'; $IX33892 .= '<label>'; $IX33892 .= esc_html( stripslashes( $IX17752['label'] ) ); $IX33892 .= ' '; $IX41871 = isset( $IX17752['type'] ) ? $IX17752['type'] : 'text'; $IX82875 = get_user_meta( $IX65890->ID, $IX14214 , true ); $IX33892 .= sprintf( '<input type="text" value="%s" readonly="readonly" />', esc_attr( stripslashes( $IX82875 ) ) ); $IX33892 .= '</label>'; $IX33892 .= '</div>'; } } } } $IX31774 = ( is_ssl() ? 'https://' : 'http://' ) . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $IX31774 = remove_query_arg( 'action', $IX31774 ); $IX31774 = remove_query_arg( 'affiliate_id', $IX31774 ); $IX14214 = isset( $_POST['name-field'] ) ? $_POST['name-field'] : $IX39558['name']; $IX80647 = isset( $_POST['email-field'] ) ? $_POST['email-field'] : $IX39558['email']; $IX78391 = isset( $_POST['user-field'] ) ? $_POST['user-field'] : ( $IX65890 != null ? $IX65890->user_login : '' ); $IX80798 = isset( $_POST['from-date-field'] ) ? $_POST['from-date-field'] : $IX39558['from_date']; $IX27864 = isset( $_POST['thru-date-field'] ) ? $_POST['thru-date-field'] : $IX39558['thru_date']; $IX40655 = isset( $_POST['status'] ) ? $_POST['status'] : $IX39558['status']; $IX94932 = ''; if ( isset( $_POST['errors'] ) && is_array( $_POST['errors'] ) ) { $IX31125 = array(); foreach( $_POST['errors'] as $IX87364 ) { switch ( $IX87364 ) { case AFFILIATES_ADMIN_AFFILIATES_ERROR_NAME_EMPTY : $IX31125[] = __('名稱不能為空。', 'affiliates' ); break; case AFFILIATES_ADMIN_AFFILIATES_ERROR_USERNAME : $IX31125[] = __('用戶名不存在。', 'affiliates' ); break; default: $IX31125[] = __('出了些問題。', 'affiliates' ); break; } } $IX94932 .= '<div class="updated error">'; $IX94932 .= implode( '<br/>', $IX31125 ); $IX94932 .= '</div>'; } $IX17142 = '<div class="manage-affiliates">' . '<div>' . '<h1>' . __('編輯聯營公司', 'affiliates' ) . '</h1>' . '</div>' . $IX94932 . '<form id="edit-affiliate" action="' . esc_url( $IX31774 ) . '" method="post">' . '<div class="affiliate edit">' . '<input id="affiliate-id-field" name="affiliate-id-field" type="hidden" value="' . esc_attr( intval( $affiliate_id ) ) . '"/>' . '<div class="field">' . '<label class="field-label first required">' . '<span class="label">' . __('姓名', 'affiliates' ) . '</span>' . ' ' . '<input id="name-field" name="name-field" class="namefield" type="text" value="' . esc_attr( stripslashes( $IX14214 ) ) . '"/>' . '</label>' . '</div>' . '<div class="field">' . '<label for="email-field" class="field-label">' . '<span class="label">' . __('電子郵件', 'affiliates' ) . '</span>' . ' ' . '<input id="email-field" name="email-field" class="emailfield" type="text" value="' . esc_attr( $IX80647 ) . '"/>' . '</label>' . ' ' . '<span class="description">' . __( "如果指定了有效的<strong>用戶名</strong>並且未提供電子郵件，則係統將自動使用用戶的電子郵件地址。", 'affiliates' ) . '</span>' . '</div>' . '<div class="field">' . '<label for="user-field" class="field-label">' . '<span class="label">' . __('用戶名', 'affiliates' ) . '</span>' . ' ' . '<input id="user-field" name="user-field" class="userfield" type="text" value="' . esc_attr( stripslashes( $IX78391 ) ) . '"/>' . '</label>' . ' ' . $IX35449 . '</div>' . $IX33892 . '<div class="field">' . '<label class="field-label first">' . '<span class="label">' . __('從', 'affiliates' ) . '</span>' . ' ' . '<input id="from-date-field" name="from-date-field" class="datefield" type="text" value="' . esc_attr( $IX80798 ) . '"/>' . '</label>' . '</div>' . '<div class="field">' . '<label class="field-label">' . '<span class="label">' . __('直到', 'affiliates' ) . '</span>' . ' ' . '<input id="thru-date-field" name="thru-date-field" class="datefield" type="text" value="' . esc_attr( $IX27864 ) . '"/>' . '</label>' . '</div>'; $IX17142 .= '<div class="field">' . '<label class="field-label">' . '<span class="label">' . __('地位', 'affiliates' ) . '</span>' . ' ' . '<select id="status" name="status" class="datafield">' . '<option value="active" ' . ( $IX40655 == 'active' ? 'selected="selected"' : '' ) . ' >' . __('Accepted', 'affiliates') . '</option>' . '<option value="pending" ' . ( $IX40655 == 'pending' ? 'selected="selected"' : '' ) . ' >' . __('Pending', 'affiliates') . '</option>' . '<option value="deleted" ' . ( $IX40655 == 'deleted' ? 'selected="selected"' : '' ) . ' >' . __('Deleted', 'affiliates') . '</option>' . '</select>' . '</label>' . '</div>'; $IX17142 .= '<div class="field">' . wp_nonce_field( plugin_basename( __FILE__ ), AFFILIATES_ADMIN_AFFILIATES_NONCE, true, false ) . '<input class="button button-primary" type="submit" value="' . __('節省', 'affiliates' ) . '"/>' . '<input type="hidden" value="edit" name="action"/>' . ' ' . '<a class="button" class="cancel" href="' . esc_url( $IX31774 ) . '">' . __('取消', 'affiliates' ) . '</a>' . '</div>' . '</div>' . '</form>' . '</div>'; echo $IX17142; do_action( 'affiliates_after_edit_affiliate_form', $affiliate_id ); $IX44859 = new Affiliates_Attributes_WordPress(); $IX44859->view( $affiliate_id ); do_action( 'affiliates_after_edit_affiliate_attributes', $affiliate_id );  }

	function edit_submit() { global $wpdb; $IX37818 = array(); if ( !current_user_can( AFFILIATES_ADMINISTER_AFFILIATES ) ) { wp_die( __( '拒絕訪問。', 'affiliates' ) ); } if ( !isset( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE] ) || !wp_verify_nonce( $_POST[AFFILIATES_ADMIN_AFFILIATES_NONCE], plugin_basename( __FILE__ ) ) ) { wp_die( __( '拒絕訪問。', 'affiliates' ) ); } $IX20211 = _affiliates_get_tablename( 'affiliates' ); $IX51981 = _affiliates_get_tablename( 'affiliates_users' ); $IX47453 = isset( $_POST['affiliate-id-field'] ) ? $_POST['affiliate-id-field'] : null; $IX45755 = false; $IX68129 = null; if ( $IX68129 = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $IX20211 WHERE affiliate_id = %d", intval( $IX47453 ) ) ) ) { $IX45755 = isset( $IX68129->type ) && ( $IX68129->type == AFFILIATES_DIRECT_TYPE ); } if ( empty( $IX68129 ) ) { wp_die( __('沒有這樣的附屬機構。', 'affiliates' ) ); } $IX51763 = self::get_affiliate( $IX47453 ); $IX26059 = isset( $_POST['name-field'] ) ? trim( $_POST['name-field'] ) : null; if ( $IX45755 ) { $IX26059 = AFFILIATES_DIRECT_NAME; } if ( empty( $IX26059 ) ) { $IX37818['errors'][] = AFFILIATES_ADMIN_AFFILIATES_ERROR_NAME_EMPTY; } $IX70097 = true; if ( !empty( $_POST['user-field'] ) ) { $IX52321 = trim( $_POST['user-field'] ); if ( !empty( $IX52321 ) ) { if ( !get_user_by( 'login', $IX52321 ) ) { $IX70097 = false; $IX37818['errors'][] = AFFILIATES_ADMIN_AFFILIATES_ERROR_USERNAME; } } } if ( !empty( $IX26059 ) && $IX70097 ) { $IX98793 = array( 'name' => $IX26059 ); $IX67119 = array( '%s' ); $IX44894 = trim( $_POST['email-field'] ); if ( is_email( $IX44894 ) ) { $IX98793['email'] = $IX44894; $IX67119[] = '%s'; } else { $IX98793['email'] = null; $IX67119[] = 'NULL'; } $IX96993 = $_POST['from-date-field']; if ( empty( $IX96993 ) ) { $IX96993 = date( 'Y-m-d', time() ); } else { $IX96993 = date( 'Y-m-d', strtotime( $IX96993 ) ); } $IX98793['from_date'] = $IX96993; $IX67119[] = '%s'; $IX77398 = $_POST['thru-date-field']; if ( !empty( $IX77398 ) && strtotime( $IX77398 ) < strtotime( $IX96993 ) ) { $IX77398 = null; } if ( !empty( $IX77398 ) ) { $IX77398 = date( 'Y-m-d', strtotime( $IX77398 ) ); $IX98793['thru_date'] = $IX77398; $IX67119[] = '%s'; } else { $IX98793['thru_date'] = null; $IX67119[] = 'NULL'; } $IX37795 = $_POST['status']; $IX82010 = $IX68129->status; if ( empty( $IX37795 ) ) { $IX37795 = get_option( 'aff_status', 'active' ); } $IX98793['status'] = $IX37795; $IX67119[] = '%s'; $IX98868 = array(); $IX71765 = array(); $IX78617 = 0; foreach( $IX98793 as $IX75587 => $IX12690 ) { $IX98868[] = $IX75587 . ' = ' . $IX67119[$IX78617]; if ( $IX12690 ) { $IX71765[] = $IX12690; } $IX78617++; } if ( !empty( $IX98868 ) ) { $IX98868 = implode( ', ', $IX98868 ); $IX71765[] = intval( $IX47453 ); $IX95435 = $wpdb->prepare( "UPDATE $IX20211 SET $IX98868 WHERE affiliate_id = %d", $IX71765 ); $wpdb->query( $IX95435 ); } $IX95079 = $wpdb->get_row( $wpdb->prepare(" SELECT affiliate_id, user_id, user_login FROM $IX51981 LEFT JOIN $wpdb->users ON $IX51981.user_id = $wpdb->users.ID WHERE affiliate_id = %d", intval( $IX47453 ) ) ); $IX91008 = trim( $_POST['user-field'] ); if ( ( empty( $IX91008 ) && !empty( $IX95079 ) ) || ( !empty( $IX95079 ) && ( strcmp( $IX95079->user_login, $IX91008 ) !== 0 ) ) ) { $wpdb->query( $wpdb->prepare( "DELETE FROM $IX51981 WHERE affiliate_id = %d", intval( $IX47453 ) ) ); } if ( !empty( $IX47453 ) && !empty( $IX91008 ) && ( empty( $IX95079 ) || ( !empty( $IX95079 ) && ( strcmp( $IX95079->user_login, $IX91008 ) !== 0 ) ) ) ) { $IX59276 = get_user_by( 'login', $IX91008 ); if ( !empty( $IX59276 ) ) { if ( $wpdb->query( $wpdb->prepare( "INSERT INTO $IX51981 SET affiliate_id = %d, user_id = %d", intval( $IX47453 ), intval( $IX59276->ID ) ) ) ) { if ( empty( $IX44894 ) && !empty( $IX59276->user_email ) ) { $wpdb->query( $wpdb->prepare( "UPDATE $IX20211 SET email = %s WHERE affiliate_id = %d", $IX59276->user_email, $IX47453 ) ); } } } } $IX86430 = self::get_affiliate( $IX47453 ); if ( $IX51763->name != $IX86430->name ) { do_action( 'affiliates_updated_name', $IX47453, $IX51763->name, $IX86430->name ); } if ( $IX51763->email != $IX86430->email ) { do_action( 'affiliates_updated_email', $IX47453, $IX51763->email, $IX86430->email ); } if ( !empty( $IX47453 ) ) { do_action( 'affiliates_updated_affiliate', intval( $IX47453 ) ); if ( !empty( $IX37795 ) ) { do_action( 'affiliates_updated_affiliate_status', intval( $IX47453 ), $IX82010, $IX37795 ); } } } return $IX37818; }

}
